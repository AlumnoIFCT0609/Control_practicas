<html xmlns:th="http://www.thymeleaf.org">

<div th:fragment="content">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">
                            <i class="bi bi-clipboard-check"></i>
                            <span th:text="${evaluacion.id == null ? 'Nueva Evaluaci√≥n de Tutor' : 'Editar Evaluaci√≥n de Tutor'}">
                                Nueva Evaluaci√≥n de Tutor
                            </span>
                        </h3>
                    </div>

                    <div class="card-body">
                        <form th:object="${evaluacion}"
                              method="post"
                              th:action="@{/evaluaciontutor/guardar}">

                            <input type="hidden" th:field="*{id}" />

                            <!-- DATOS DE LA EVALUACI√ìN -->
                            <h5 class="border-bottom pb-2 mb-3">Datos de la Evaluaci√≥n</h5>

                            <div class="row">
                                <!-- Tutor de Curso -->
                                <div class="col-md-6 mb-3">
                                    <label for="tutorCurso" class="form-label">
                                        <i class="bi bi-person-badge"></i> Tutor de Curso <span class="text-danger">*</span>
                                    </label>
                                    <select th:disabled="${soloLectura}" 
                                            id="tutorCurso" 
                                            name="tutorCursoId" 
                                            class="form-select"
                                            required>
                                        <option value="">Seleccione un tutor de curso</option>
                                        <option th:each="tutor : ${tutoresCurso}" 
                                                th:value="${tutor.id}" 
                                                th:text="${tutor.nombre} + ' ' + ${tutor.apellidos}"
                                                th:selected="${evaluacion.tutorCurso != null and tutor.id == evaluacion.tutorCurso.id}">
                                        </option>
                                    </select>
                                </div>

                                <!-- Tutor de Pr√°cticas -->
                                <div class="col-md-6 mb-3">
                                    <label for="tutorPracticas" class="form-label">
                                        <i class="bi bi-briefcase"></i> Tutor de Pr√°cticas <span class="text-danger">*</span>
                                    </label>
                                    <select th:disabled="${soloLectura}" 
                                            id="tutorPracticas"  
                                            name="tutorPracticasId" 
                                            class="form-select"
                                            required
                                            disabled>
                                        <option value="">Primero seleccione un tutor de curso</option>
                                        <option th:each="tutor : ${tutoresPracticas}" 
                                                th:value="${tutor.id}" 
                                                th:text="${tutor.nombre} + ' ' + ${tutor.apellidos}"
                                                th:selected="${evaluacion.tutorPracticas != null and tutor.id == evaluacion.tutorPracticas.id}">
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fecha" class="form-label">
                                        <i class="bi bi-calendar-event"></i> Fecha de Evaluaci√≥n <span class="text-danger">*</span>
                                    </label>
                                    <input type="date" 
                                           class="form-control" 
                                           id="fecha" 
                                           name="fecha"
                                           th:value="${evaluacion.fecha != null ? evaluacion.fecha.toString() : ''}" 
                                           required />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="puntuacion" class="form-label">
                                        <i class="bi bi-star-fill"></i> Puntuaci√≥n <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           id="puntuacion"
                                           th:field="*{puntuacion}"
                                           min="0" 
                                           max="10" 
                                           step="0.01" 
                                           placeholder="0.00 - 10.00" 
                                           required />
                                    <small class="form-text text-muted">Ingrese un valor entre 0.00 y 10.00</small>
                                </div>
                            </div>

                            <!-- ASPECTOS DE LA EVALUACI√ìN -->
                            <h5 class="border-bottom pb-2 mb-3 mt-4">Aspectos de la Evaluaci√≥n</h5>

                            <div class="mb-3">
                                <label for="aspectosPositivos" class="form-label">
                                    <i class="bi bi-hand-thumbs-up"></i> Aspectos Positivos
                                </label>
                                <textarea class="form-control" 
                                          id="aspectosPositivos"
                                          th:field="*{aspectosPositivos}"
                                          rows="4" 
                                          placeholder="Describa los aspectos positivos observados..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="aspectosMejorar" class="form-label">
                                    <i class="bi bi-arrow-up-circle"></i> Aspectos a Mejorar
                                </label>
                                <textarea class="form-control" 
                                          id="aspectosMejorar"
                                          th:field="*{aspectosMejorar}"
                                          rows="4" 
                                          placeholder="Describa los aspectos que requieren mejora..."></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="observaciones" class="form-label">
                                    <i class="bi bi-chat-square-text"></i> Observaciones Generales
                                </label>
                                <textarea class="form-control" 
                                          id="observaciones"
                                          th:field="*{observaciones}"
                                          rows="4" 
                                          placeholder="A√±ada observaciones adicionales..."></textarea>
                            </div>

                            <!-- BOTONES -->
                            <div class="d-flex justify-content-between mt-4">
                                <div th:switch="${#lists.contains(#authentication.authorities.![authority], 'ALUMNO')}">
                                    <a th:case="true" th:href="@{/alumno/dashboard}" class="btn btn-secondary">
                                        <i class="bi bi-arrow-left"></i> Cancelar
                                    </a>
                                    <a th:case="false" th:href="@{/evaluaciontutor/listar}" class="btn btn-secondary">
                                        <i class="bi bi-arrow-left"></i> Cancelar
                                    </a>
                                </div>

                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Guardar
                                </button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:fragment="scripts">
<script>


const tutorCursoSelect = document.getElementById('tutorCurso');
const tutorPracticasSelect = document.getElementById('tutorPracticas');
const soloLectura = [[${soloLectura}]];

// ============================================
// TutorCurso ‚Üí TutorPracticas
// ============================================
if (tutorCursoSelect) {
    tutorCursoSelect.addEventListener('change', async function() {
        const tutorCursoId = this.value;
        console.log('Tutor Curso seleccionado:', tutorCursoId);
        
        // Si es solo lectura, no hacer nada
        if (soloLectura) {
            console.log('Solo lectura activo, no se recarga');
            return;
        }
        
        // Reset tutor pr√°cticas
        tutorPracticasSelect.innerHTML = '<option value="">Cargando...</option>';
        
        if (!tutorCursoId) {
            tutorPracticasSelect.innerHTML = '<option value="">Primero seleccione un tutor de curso</option>';
            tutorPracticasSelect.disabled = true;
            return;
        }
        
        try {
            const response = await fetch(`/evaluaciontutor/tutores-practicas-por-tutor/${tutorCursoId}`);
            const tutores = await response.json();
            console.log('üë®‚Äçüíº Tutores de pr√°cticas recibidos:', tutores);
            
            tutorPracticasSelect.innerHTML = '<option value="">Seleccione un tutor de pr√°cticas</option>';
            
            if (!tutores || tutores.length === 0) {
                tutorPracticasSelect.innerHTML = '<option value="">No hay tutores de pr√°cticas para este tutor de curso</option>';
                tutorPracticasSelect.disabled = true;
                return;
            }
            
            tutores.forEach(tutor => {
                const option = document.createElement('option');
                option.value = tutor.id;
                option.textContent = tutor.nombre;
                tutorPracticasSelect.appendChild(option);
            });
            
            tutorPracticasSelect.disabled = false;
            
        } catch (error) {
            console.error('‚ùå Error al cargar tutores de pr√°cticas:', error);
            tutorPracticasSelect.innerHTML = '<option value="">Error al cargar tutores</option>';
            tutorPracticasSelect.disabled = true;
        }
    });
}

// ============================================
// INICIALIZACI√ìN (para modo edici√≥n)
// ============================================
window.addEventListener('DOMContentLoaded', function() {
    console.log('üü¢ Sistema de filtrado din√°mico inicializado');
    console.log('üìã Solo lectura:', soloLectura);
    
    // Guardar el valor preseleccionado de tutor pr√°cticas (modo edici√≥n o alumno)
    const tutorPracticasPreseleccionado = tutorPracticasSelect.value;
    console.log('üíæ Tutor pr√°cticas preseleccionado:', tutorPracticasPreseleccionado);
    
    // Si hay un tutor curso preseleccionado y NO es solo lectura
    if (tutorCursoSelect && tutorCursoSelect.value && !soloLectura) {
        console.log('üîÑ Modo edici√≥n: cargando tutores de pr√°cticas...');
        
        // Cargar los tutores y luego restaurar la selecci√≥n
        tutorCursoSelect.addEventListener('change', function handler() {
            // Esperar un poco a que se carguen las opciones
            setTimeout(() => {
                if (tutorPracticasPreseleccionado) {
                    tutorPracticasSelect.value = tutorPracticasPreseleccionado;
                    console.log('‚úÖ Tutor pr√°cticas restaurado:', tutorPracticasPreseleccionado);
                }
            }, 300);
            // Remover el listener para que solo se ejecute una vez
            tutorCursoSelect.removeEventListener('change', handler);
        });
        
        tutorCursoSelect.dispatchEvent(new Event('change'));
    }
    
    // Si es solo lectura (ALUMNO), deshabilitar ambos selects
    if (soloLectura) {
        tutorCursoSelect.disabled = true;
        tutorPracticasSelect.disabled = true;
        console.log('üîí Modo solo lectura: selects bloqueados');
    }
});

</script>
</th:block>

</html>