<div th:fragment="content">
    <!-- Encabezado y Botón de Exportación -->
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0 text-gray-800">Reportes del Sistema</h1>
            <button onclick="exportToPDF()" class="btn btn-danger" id="btnExportPDF">
                <i class="fas fa-file-pdf"></i> Exportar a PDF
            </button>
        </div>

        <!-- SECCIÓN 1: HISTÓRICO DE REGISTROS -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">1. Histórico de Registros</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Histórico por Curso -->
                    <div class="col-xl-6 col-lg-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                            Total Cursos Registrados
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${cursos.size()}">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-graduation-cap fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                                <hr>
                                <div class="small text-muted">
                                    <strong>Cursos Activos:</strong> 
                                    <span th:text="${cursosActivos}">0</span>
                                </div>
                                <div class="small text-muted">
                                    <strong>Cursos Finalizados (Inactivos):</strong> 
                                    <span th:text="${cursosFinalizados}">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Histórico por Empresa -->
                    <div class="col-xl-6 col-lg-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Total Empresas Registradas
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${empresas.size()}">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-building fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                                <hr>
                                <div class="small text-muted">
                                    <strong>Empresas Activas:</strong> 
                                    <span th:text="${empresasActivas}">0</span>
                                </div>
                                <div class="small text-muted">
                                    <strong>Empresas Inactivas:</strong> 
                                    <span th:text="${empresasInactivas}">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Histórico Tutores de Curso -->
                    <div class="col-xl-6 col-lg-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2">
                            <div class="card-body">
                                 <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Total Tutores de Curso Registrados
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${tutorC.size()}">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-building fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                                <hr>
                                <div class="small text-muted">
                                    <strong>Tutores de Curso Activos:</strong> 
                                    <span th:text="${tutorCurso}">0</span>
                                </div>
                                <div class="small text-muted">
                                    <strong>Tutores Inactivos:</strong> 
                                    <span th:text="${tutorCursoInac}">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Histórico Tutores de Prácticas -->
                    <div class="col-xl-6 col-lg-6 mb-4">
                        <div class="card border-left-warning shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                            Total Tutores de Prácticas Registrados
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${tutorP.size()}">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-building fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                                <hr>
                                <div class="small text-muted">
                                    <strong>Tutores de Prácticas Activos:</strong> 
                                    <span th:text="${tutorPracticas}">0</span>
                                </div>
                                <div class="small text-muted">
                                    <strong>Tutores Inactivos:</strong> 
                                    <span th:text="${tutorPracticasInac}">0</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Histórico de Alumnos -->
                    <div class="col-xl-12 col-lg-12 mb-4">
                        <div class="card border-left-danger shadow h-100 py-2">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                            Total Alumnos Registrados
                                        </div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" th:text="${alumnos.size()}">0</div>
                                    </div>
                                    <div class="col-auto">
                                        <i class="fas fa-users fa-2x text-gray-300"></i>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="small text-muted">
                                            <strong>Alumnos en Prácticas:</strong> 
                                            <span th:text="${alumnosEnPracticas}">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="small text-muted">
                                            <strong>Alumnos Finalizados:</strong> 
                                            <span th:text="${alumnosFinalizados}">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIÓN 2: RANKINGS -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">2. Rankings</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Ranking Cursos con más alumnos -->
                    <div class="col-xl-6 mb-4">
                        <h6 class="font-weight-bold text-primary">Top 5 Cursos con Más Alumnos</h6>
                        <canvas id="rankingCursosChart"></canvas>
                        <div class="table-responsive mt-3">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Curso</th>
                                        <th>Alumnos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="curso, iterStat : ${cursos}" th:if="${iterStat.index < 5}">
                                        <td th:text="${iterStat.count}">1</td>
                                        <td th:text="${curso.nombre}">Nombre Curso</td>
                                        <td th:text="${alumnosPorCurso.get(curso.id) ?: 0}">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Ranking Empresas con más alumnos -->
                    <div class="col-xl-6 mb-4">
                        <h6 class="font-weight-bold text-success">Top 5 Empresas con Más Alumnos</h6>
                        <canvas id="rankingEmpresasChart"></canvas>
                        <div class="table-responsive mt-3">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Empresa</th>
                                        <th>Alumnos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="empresa, iterStat : ${empresas}" th:if="${iterStat.index < 5}">
                                        <td th:text="${iterStat.count}">1</td>
                                        <td th:text="${empresa.nombre}">Nombre Empresa</td>
                                        <td th:text="${empresa.alumnos.size()}">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIÓN 3: DIAGRAMA DE GANTT - CRONOLOGÍA DE CURSOS -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">3. Cronología de Cursos (Diagrama de Gantt)</h6>
                <small class="text-muted">Visualización de períodos de cursos para detectar solapamientos de tutores</small>
            </div>
            <div class="card-body">
                <!-- Canvas para el Diagrama de Gantt -->
                <div style="position: relative; height: 400px; overflow-x: auto;">
                    <canvas id="ganttChart"></canvas>
                </div>
                
                <!-- Tabla de Datos Detallada -->
                <div class="table-responsive mt-4">
                    <table class="table table-bordered table-sm table-hover">
                        <thead class="thead-light">
                            <tr>
                                <th>Curso</th>
                                <th>Tutor</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Fin</th>
                                <th>Duración (días)</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="curso : ${cursos}">
                                <td><strong th:text="${curso.nombre}">Curso</strong></td>
                                <td>
                                    <span th:if="${curso.tutorCurso != null}" 
                                          th:text="${curso.tutorCurso.nombre + ' ' + curso.tutorCurso.apellidos}"
                                          class="badge badge-info">
                                        Tutor
                                    </span>
                                    <span th:unless="${curso.tutorCurso != null}" class="badge badge-secondary">Sin asignar</span>
                                </td>
                                <td th:text="${curso.fechaInicio != null ? #temporals.format(curso.fechaInicio, 'dd/MM/yyyy') : 'N/A'}">01/01/2024</td>
                                <td th:text="${curso.fechaFin != null ? #temporals.format(curso.fechaFin, 'dd/MM/yyyy') : 'N/A'}">31/12/2024</td>
                                <td>
                                    <span th:if="${curso.duracion != null}" th:text="${curso.duracion + ' días'}">365 días</span>
                                    <span th:unless="${curso.duracion != null}" class="text-muted">N/A</span>
                                </td>
                                <td>
                                    <span th:if="${curso.activo}" class="badge badge-success">Activo</span>
                                    <span th:unless="${curso.activo}" class="badge badge-warning">Finalizado</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Alertas de Solapamiento -->
                <div id="solapamientoAlerts" class="mt-3"></div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Nota:</strong> El diagrama muestra visualmente los períodos de cada curso. 
                    Los cursos con el mismo color tienen el mismo tutor. 
                    Si hay barras del mismo color que se solapan en el tiempo, indica que el tutor tiene múltiples cursos simultáneos.
                </div>
            </div>
        </div>

        <!-- SECCIÓN 4: RANKINGS DE TUTORES -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">4. Rankings de Tutores</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Ranking Tutores de Curso -->
                    <div class="col-xl-6 mb-4">
                        <h6 class="font-weight-bold text-info">Top Tutores de Curso (por número de cursos)</h6>
                        <canvas id="rankingTutoresCursoChart"></canvas>
                        <div class="table-responsive mt-3">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tutor</th>
                                        <th>Cursos Tutorizados</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="tC, iterStat : ${tutorC}">
                                        <td th:text="${iterStat.count}">1</td>
                                        <td th:text="${tC.nombre + ' ' + tC.apellidos}">Nombre Tutor</td>
                                        <td th:text="${tC.cursos != null ? tC.cursos.size() : 0}">0</td>
                                        <td>
                                            <span th:if="${tC.activo}" class="badge badge-success">Activo</span>
                                            <span th:unless="${tC.activo}" class="badge badge-secondary">Inactivo</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Ranking Tutores de Prácticas -->
                    <div class="col-xl-6 mb-4">
                        <h6 class="font-weight-bold text-warning">Top Tutores de Prácticas (por número de alumnos)</h6>
                        <canvas id="rankingTutoresPracticasChart"></canvas>
                        <div class="table-responsive mt-3">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Tutor</th>
                                        <th>Empresa</th>
                                        <th>Alumnos</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="tP, iterStat : ${tutorP}">
                                        <td th:text="${iterStat.count}">1</td>
                                        <td th:text="${tP.nombre + ' ' + tP.apellidos}">Nombre Tutor</td>
                                        <td th:text="${tP.empresa != null ? tP.empresa.nombre : 'Sin empresa'}">Empresa</td>
                                        <td th:text="${tP.alumnos != null ? tP.alumnos.size() : 0}">0</td>
                                        <td>
                                            <span th:if="${tP.activo}" class="badge badge-success">Activo</span>
                                            <span th:unless="${tP.activo}" class="badge badge-secondary">Inactivo</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts para Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Variables de datos serializadas como JSON -->
    <script>
        var cursosData = JSON.parse('[(${cursosJson})]');
        var empresasData = JSON.parse('[(${empresasJson})]');
        var alumnosPorCursoData = JSON.parse('[(${alumnosPorCursoJson})]');
        var tutoresCursoData = JSON.parse('[(${tutoresCursoJson})]');
        var tutoresPracticasData = JSON.parse('[(${tutoresPracticasJson})]');
        
        console.log('Variables cargadas:', {
            cursos: cursosData.length,
            empresas: empresasData.length,
            tutores: tutoresCursoData.length
        });
    </script>
    
    <script>
    // Esperar a que el DOM esté completamente cargado
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM cargado, inicializando gráficos...');
        
        // Verificar que Chart.js esté disponible
        if (typeof Chart === 'undefined') {
            console.error('Chart.js no está cargado');
            return;
        }
        
        // Usar las variables globales definidas arriba
        const cursos = cursosData || [];
        const empresas = empresasData || [];
        const alumnosPorCurso = alumnosPorCursoData || {};
        const tutoresCurso = tutoresCursoData || [];
        const tutoresPracticas = tutoresPracticasData || [];

        console.log('Datos cargados:', {
            cursos: cursos.length,
            empresas: empresas.length,
            tutoresCurso: tutoresCurso.length,
            tutoresPracticas: tutoresPracticas.length
        });

        // Gráfico: Ranking de Cursos
        const cursosOrdenados = cursos
            .map(c => ({nombre: c.nombre, alumnos: alumnosPorCurso[c.id] || 0}))
            .sort((a, b) => b.alumnos - a.alumnos)
            .slice(0, 5);
        
        new Chart(document.getElementById('rankingCursosChart'), {
            type: 'bar',
            data: {
                labels: cursosOrdenados.map(c => c.nombre),
                datasets: [{
                    label: 'Número de Alumnos',
                    data: cursosOrdenados.map(c => c.alumnos),
                    backgroundColor: 'rgba(78, 115, 223, 0.8)',
                    borderColor: 'rgba(78, 115, 223, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Gráfico: Ranking de Empresas
        const empresasOrdenadas = empresas
            .map(e => ({nombre: e.nombre, alumnos: e.alumnos ? e.alumnos.length : 0}))
            .sort((a, b) => b.alumnos - a.alumnos)
            .slice(0, 5);
        
        new Chart(document.getElementById('rankingEmpresasChart'), {
            type: 'bar',
            data: {
                labels: empresasOrdenadas.map(e => e.nombre),
                datasets: [{
                    label: 'Número de Alumnos',
                    data: empresasOrdenadas.map(e => e.alumnos),
                    backgroundColor: 'rgba(28, 200, 138, 0.8)',
                    borderColor: 'rgba(28, 200, 138, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });

        // Gráfico: Ranking Tutores de Curso
        const tutoresOrdenados = tutoresCurso
            .map(t => ({nombre: t.nombre + ' ' + t.apellidos, cursos: t.cursos ? t.cursos.length : 0}))
            .sort((a, b) => b.cursos - a.cursos)
            .slice(0, 5);

        new Chart(document.getElementById('rankingTutoresCursoChart'), {
            type: 'bar',
            data: {
                labels: tutoresOrdenados.map(t => t.nombre),
                datasets: [{
                    label: 'Cursos Tutorizados',
                    data: tutoresOrdenados.map(t => t.cursos),
                    backgroundColor: 'rgba(54, 185, 204, 0.8)',
                    borderColor: 'rgba(54, 185, 204, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });

        // Gráfico: Ranking Tutores de Prácticas
        const tutoresPracticasOrdenados = tutoresPracticas
            .map(t => ({nombre: t.nombre + ' ' + t.apellidos, alumnos: t.alumnos ? t.alumnos.length : 0}))
            .sort((a, b) => b.alumnos - a.alumnos)
            .slice(0, 5);
        
        new Chart(document.getElementById('rankingTutoresPracticasChart'), {
            type: 'bar',
            data: {
                labels: tutoresPracticasOrdenados.map(t => t.nombre),
                datasets: [{
                    label: 'Alumnos Supervisados',
                    data: tutoresPracticasOrdenados.map(t => t.alumnos),
                    backgroundColor: 'rgba(246, 194, 62, 0.8)',
                    borderColor: 'rgba(246, 194, 62, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });

        // ==== DIAGRAMA DE GANTT ====
        console.log('Iniciando Diagrama de Gantt...');
        
        const cursosDataGantt = cursos;
        console.log('Cursos para Gantt:', cursosDataGantt.length);
        
        // Procesar datos de cursos
        const cursosConFechas = cursosDataGantt
            .filter(c => c.fechaInicio && c.fechaFin)
            .map(c => {
                // Parsear fechas correctamente
                let fechaInicio, fechaFin;
                
                if (Array.isArray(c.fechaInicio)) {
                    // Formato: [año, mes, día]
                    fechaInicio = new Date(c.fechaInicio[0], c.fechaInicio[1] - 1, c.fechaInicio[2]);
                } else {
                    fechaInicio = new Date(c.fechaInicio);
                }
                
                if (Array.isArray(c.fechaFin)) {
                    fechaFin = new Date(c.fechaFin[0], c.fechaFin[1] - 1, c.fechaFin[2]);
                } else {
                    fechaFin = new Date(c.fechaFin);
                }
                
                return {
                    nombre: c.nombre,
                    tutor: c.tutorCurso ? (c.tutorCurso.nombre + ' ' + c.tutorCurso.apellidos) : 'Sin asignar',
                    tutorId: c.tutorCurso ? c.tutorCurso.id : null,
                    fechaInicio: fechaInicio,
                    fechaFin: fechaFin,
                    activo: c.activo
                };
            })
            .sort((a, b) => a.fechaInicio - b.fechaInicio);

        console.log('Cursos con fechas procesados:', cursosConFechas.length);

        if (cursosConFechas.length === 0) {
            const ganttContainer = document.getElementById('ganttChart');
            if (ganttContainer) {
                ganttContainer.parentElement.innerHTML = 
                    '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> No hay cursos con fechas definidas para mostrar en el diagrama.</div>';
            }
            return;
        }

        // Crear paleta de colores por tutor
        const tutoresUnicos = [...new Set(cursosConFechas.map(c => c.tutor))];
        console.log('Tutores únicos:', tutoresUnicos);
        
        const coloresPorTutor = {};
        const paleta = [
            'rgba(78, 115, 223, 0.8)',
            'rgba(28, 200, 138, 0.8)',
            'rgba(54, 185, 204, 0.8)',
            'rgba(246, 194, 62, 0.8)',
            'rgba(231, 74, 59, 0.8)',
            'rgba(133, 135, 150, 0.8)',
            'rgba(255, 99, 132, 0.8)',
            'rgba(255, 159, 64, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)'
        ];
        
        tutoresUnicos.forEach((tutor, idx) => {
            coloresPorTutor[tutor] = paleta[idx % paleta.length];
        });

        // Encontrar rango de fechas
        const todasLasFechas = cursosConFechas.flatMap(c => [c.fechaInicio.getTime(), c.fechaFin.getTime()]);
        const minFecha = new Date(Math.min(...todasLasFechas));
        const maxFecha = new Date(Math.max(...todasLasFechas));
        
        console.log('Rango de fechas:', minFecha.toLocaleDateString(), '-', maxFecha.toLocaleDateString());

        // Crear el gráfico
        const ctx = document.getElementById('ganttChart');
        if (!ctx) {
            console.error('No se encontró el canvas con id "ganttChart"');
            return;
        }
        
        try {
            const ganttChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: cursosConFechas.map(c => c.nombre),
                    datasets: [{
                        label: 'Duración del curso',
                        data: cursosConFechas.map((c) => {
                            const duracion = c.fechaFin.getTime() - c.fechaInicio.getTime();
                            const totalRango = maxFecha.getTime() - minFecha.getTime();
                            return (duracion / totalRango) * 100;
                        }),
                        backgroundColor: cursosConFechas.map(c => coloresPorTutor[c.tutor]),
                        borderColor: cursosConFechas.map(c => coloresPorTutor[c.tutor].replace('0.8', '1')),
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                generateLabels: function() {
                                    return tutoresUnicos.map(tutor => ({
                                        text: tutor,
                                        fillStyle: coloresPorTutor[tutor],
                                        strokeStyle: coloresPorTutor[tutor].replace('0.8', '1'),
                                        lineWidth: 2
                                    }));
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const curso = cursosConFechas[context.dataIndex];
                                    const inicio = curso.fechaInicio.toLocaleDateString('es-ES');
                                    const fin = curso.fechaFin.toLocaleDateString('es-ES');
                                    const dias = Math.ceil((curso.fechaFin - curso.fechaInicio) / (1000 * 60 * 60 * 24));
                                    return [
                                        `Tutor: ${curso.tutor}`,
                                        `Inicio: ${inicio}`,
                                        `Fin: ${fin}`,
                                        `Duración: ${dias} días`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    const fechaCalculada = new Date(minFecha.getTime() + (value / 100) * (maxFecha.getTime() - minFecha.getTime()));
                                    return fechaCalculada.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
                                }
                            },
                            title: {
                                display: true,
                                text: `Línea de Tiempo (${minFecha.toLocaleDateString('es-ES')} - ${maxFecha.toLocaleDateString('es-ES')})`
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Cursos'
                            }
                        }
                    }
                }
            });
            
            console.log('Gráfico de Gantt creado exitosamente');
        } catch (error) {
            console.error('Error al crear el gráfico de Gantt:', error);
        }

        // Detectar solapamientos
        const solapamientos = [];
        for (let i = 0; i < cursosConFechas.length; i++) {
            for (let j = i + 1; j < cursosConFechas.length; j++) {
                const curso1 = cursosConFechas[i];
                const curso2 = cursosConFechas[j];
                
                // Verificar si tienen el mismo tutor y no es "Sin asignar"
                if (curso1.tutorId && curso1.tutorId === curso2.tutorId) {
                    // Verificar solapamiento de fechas
                    const seSuperponen = curso1.fechaInicio <= curso2.fechaFin && 
                                         curso2.fechaInicio <= curso1.fechaFin;
                    
                    if (seSuperponen) {
                        solapamientos.push({
                            tutor: curso1.tutor,
                            curso1: curso1.nombre,
                            curso2: curso2.nombre,
                            inicio1: curso1.fechaInicio.toLocaleDateString('es-ES'),
                            fin1: curso1.fechaFin.toLocaleDateString('es-ES'),
                            inicio2: curso2.fechaInicio.toLocaleDateString('es-ES'),
                            fin2: curso2.fechaFin.toLocaleDateString('es-ES')
                        });
                    }
                }
            }
        }

        console.log('Solapamientos detectados:', solapamientos.length);

        // Mostrar alertas de solapamiento
        const alertContainer = document.getElementById('solapamientoAlerts');
        if (alertContainer) {
            if (solapamientos.length > 0) {
                let alertHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> <strong>¡Atención! Solapamientos detectados:</strong><ul class="mb-0 mt-2">';
                solapamientos.forEach(s => {
                    alertHTML += `<li><strong>${s.tutor}</strong> tiene asignados:<br>
                        - "${s.curso1}" (${s.inicio1} - ${s.fin1})<br>
                        - "${s.curso2}" (${s.inicio2} - ${s.fin2})</li>`;
                });
                alertHTML += '</ul></div>';
                alertContainer.innerHTML = alertHTML;
            } else {
                alertContainer.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> No se detectaron solapamientos de tutores en los cursos.</div>';
            }
        }
        
        console.log('Todos los gráficos inicializados correctamente');
    });

    // Función para exportar a PDF
    function exportToPDF() {
        // Mostrar mensaje de carga
        const btnExport = document.getElementById('btnExportPDF');
        const btnOriginalText = btnExport.innerHTML;
        btnExport.disabled = true;
        btnExport.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando PDF...';
        
        // Convertir todos los canvas de Chart.js a imágenes antes de exportar
        const charts = document.querySelectorAll('canvas');
        const imagePromises = [];
        
        charts.forEach((canvas, index) => {
            const promise = new Promise((resolve) => {
                try {
                    // Crear una imagen del canvas
                    const imgData = canvas.toDataURL('image/png');
                    const img = document.createElement('img');
                    img.src = imgData;
                    img.style.width = canvas.style.width || canvas.width + 'px';
                    img.style.height = canvas.style.height || canvas.height + 'px';
                    
                    // Guardar referencia al canvas y su padre
                    img.dataset.canvasIndex = index;
                    const parent = canvas.parentNode;
                    
                    // Reemplazar canvas con imagen temporalmente
                    parent.replaceChild(img, canvas);
                    
                    resolve({ img, canvas, parent });
                } catch (error) {
                    console.error('Error al convertir canvas:', error);
                    resolve(null);
                }
            });
            
            imagePromises.push(promise);
        });
        
        // Esperar a que todas las imágenes estén listas
        Promise.all(imagePromises).then((replacements) => {
            const element = document.querySelector('.container-fluid.py-4');
            
            const opt = {
                margin: [5, 5, 5, 5],
                filename: 'reporte_sistema_' + new Date().toISOString().split('T')[0] + '.pdf',
                image: { 
                    type: 'jpeg', 
                    quality: 0.95 
                },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    letterRendering: true,
                    allowTaint: true
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'landscape',
                    compress: true
                },
                pagebreak: { 
                    mode: ['avoid-all', 'css', 'legacy'],
                    before: '.card'
                }
            };
            
            html2pdf().set(opt).from(element).save().then(() => {
                // Restaurar los canvas después de generar el PDF
                replacements.forEach(replacement => {
                    if (replacement) {
                        replacement.parent.replaceChild(replacement.canvas, replacement.img);
                    }
                });
                
                // Restaurar el botón
                btnExport.disabled = false;
                btnExport.innerHTML = btnOriginalText;
                
                console.log('PDF generado exitosamente');
            }).catch((error) => {
                console.error('Error al generar PDF:', error);
                
                // Restaurar los canvas en caso de error
                replacements.forEach(replacement => {
                    if (replacement) {
                        replacement.parent.replaceChild(replacement.canvas, replacement.img);
                    }
                });
                
                // Restaurar el botón
                btnExport.disabled = false;
                btnExport.innerHTML = btnOriginalText;
                
                alert('Error al generar el PDF. Por favor, intenta de nuevo.');
            });
        });
    }
    </script>
</div>