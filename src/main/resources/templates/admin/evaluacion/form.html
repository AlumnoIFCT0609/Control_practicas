<div th:fragment="content">
 <div class="container mt-5">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0" th:text="${titulo}">Nueva Evaluaci√≥n</h3>
            </div>
            <div class="card-body">
                <form th:action="@{/admin/evaluaciones/guardar}" th:object="${evaluacion}" method="post">
                    
                    <input type="hidden" th:field="*{id}">
                    
                    <div class="row">
                        <!-- Alumno -->
                        <div class="col-md-6 mb-3">
                            <label for="alumno" class="form-label">
                                <i class="bi bi-person-fill"></i> Alumno <span class="text-danger">*</span>
                            </label>
                            <select th:field="*{alumno.id}" id="alumno" class="form-select" required>
                                <option value="">Seleccione un alumno</option>
                                <option th:each="alumno : ${alumnos}" 
                                        th:value="${alumno.id}"
                                        th:text="${alumno.nombre + ' ' + alumno.apellidos}">
                                    Juan P√©rez
                                </option>
                            </select>
                        </div>

                        <!-- Tutor -->
                        <div class="col-md-6 mb-3">
                            <label for="tutor" class="form-label">
                                <i class="bi bi-person-badge"></i> Tutor de Pr√°cticas <span class="text-danger">*</span>
                            </label>
                            <select th:field="*{tutorPracticas.id}" id="tutor" class="form-select" required disabled>
                                <option value="">Primero seleccione un alumno</option>
                                <option th:each="tutor : ${tutores}" 
                                        th:value="${tutor.id}"
                                        th:text="${tutor.nombre + ' ' + tutor.apellidos}">
                                    Mar√≠a Garc√≠a
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Criterio -->
                        <div class="col-md-6 mb-3">
                            <label for="criterio" class="form-label">
                                <i class="bi bi-list-check"></i> Criterio de Evaluaci√≥n <span class="text-danger">*</span>
                            </label>
                            <select id="criterio" class="form-select" required>
                                <option value="">Seleccione un criterio</option>
                                <option th:each="criterio : ${criterios}" 
                                        th:value="${criterio.id}"
                                        th:text="${criterio.nombre + ' (Peso: ' + criterio.peso + '%)'}"
                                        th:selected="${evaluacion.capacidad != null && evaluacion.capacidad.criterio.id == criterio.id}">
                                    Competencias T√©cnicas (40%)
                                </option>
                            </select>
                        </div>

                        <!-- Capacidad -->
                        <div class="col-md-6 mb-3">
                            <label for="capacidad" class="form-label">
                                <i class="bi bi-star"></i> Capacidad a Evaluar <span class="text-danger">*</span>
                            </label>
                            <select th:field="*{capacidad.id}" id="capacidad" class="form-select" required disabled>
                                <option value="">Primero seleccione un criterio</option>
                                <option th:each="capacidad : ${capacidades}" 
                                        th:value="${capacidad.id}"
                                        th:text="${capacidad.nombre + ' (M√°x: ' + capacidad.puntuacionMaxima + ')'}"
                                        th:attr="data-criterio=${capacidad.criterio.id}, data-max=${capacidad.puntuacionMaxima}"
                                        th:selected="${evaluacion.capacidad != null && evaluacion.capacidad.id == capacidad.id}">
                                    Dominio de herramientas (M√°x: 10)
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Puntuaci√≥n -->
                        <div class="col-md-6 mb-3">
                            <label for="puntuacion" class="form-label">
                                <i class="bi bi-graph-up"></i> Puntuaci√≥n <span class="text-danger">*</span>
                            </label>
                            <input type="number" th:field="*{puntuacion}" id="puntuacion" 
                                   class="form-control" step="0.01" min="0" max="10" required>
                            <div class="form-text">Puntuaci√≥n m√°xima: <span id="maxPuntuacion">10</span></div>
                        </div>

                        <!-- Fecha -->
                        <div class="col-md-6 mb-3">
                            <label for="fecha" class="form-label">
                                <i class="bi bi-calendar-event"></i> Fecha de Evaluaci√≥n <span class="text-danger">*</span>
                            </label>
                           <input type="date" name="fecha" id="fecha" 
                             th:value="${evaluacion.fecha != null ? evaluacion.fecha.toString() : ''}"
                             class="form-control" required>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="mb-3">
                        <label for="observaciones" class="form-label">
                            <i class="bi bi-chat-square-text"></i> Observaciones
                        </label>
                        <textarea th:field="*{observaciones}" id="observaciones" 
                                  class="form-control" rows="4"
                                  placeholder="Comentarios adicionales sobre la evaluaci√≥n..."></textarea>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between mt-4">
                        <a th:href="@{/admin/evaluacion/listar}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Guardar Evaluaci√≥n
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    


</div>
<th:block th:fragment="scripts">
    
   <script>
        // Script para filtrar capacidades seg√∫n criterio seleccionado
        document.getElementById('criterio').addEventListener('change', function() {
            const criterioId = this.value;
            const capacidadSelect = document.getElementById('capacidad');
            const options = capacidadSelect.querySelectorAll('option');
            
            capacidadSelect.disabled = !criterioId;
            
            // Solo limpiar el valor si no estamos en carga inicial
            if (!this.dataset.initialLoad) {
                capacidadSelect.value = '';
            }
            delete this.dataset.initialLoad;
            
            options.forEach(option => {
                if (option.value === '') {
                    option.style.display = 'block';
                    option.textContent = criterioId ? 'Seleccione una capacidad' : 'Primero seleccione un criterio';
                } else {
                    const optionCriterio = option.getAttribute('data-criterio');
                    option.style.display = optionCriterio === criterioId ? 'block' : 'none';
                }
            });
        });

        // Actualizar puntuaci√≥n m√°xima cuando se selecciona una capacidad
        document.getElementById('capacidad').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const maxPuntuacion = selectedOption.getAttribute('data-max') || 10;
            
            document.getElementById('maxPuntuacion').textContent = maxPuntuacion;
            document.getElementById('puntuacion').setAttribute('max', maxPuntuacion);
        });
        
        document.getElementById('alumno').addEventListener('change', async function() {
            const alumnoId = this.value;
            const tutorSelect = document.getElementById('tutor');
            
            console.log('üë®‚Äçüéì Alumno seleccionado:', alumnoId);
            
            tutorSelect.innerHTML = '<option value="">Cargando tutor...</option>';
            tutorSelect.disabled = true;
            
            if (!alumnoId) {
                tutorSelect.innerHTML = '<option value="">Primero seleccione un alumno</option>';
                return;
            }
            
            try {
                const url = `/admin/evaluaciones/tutor-por-alumno/${alumnoId}`;
                console.log('üåê Haciendo fetch a:', url);
                
                const response = await fetch(url);
                console.log('üì° Status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const tutor = await response.json();
                console.log('üë®‚Äçüíº Tutor recibido:', tutor);
                
                if (tutor && tutor.id) {
                    tutorSelect.innerHTML = `<option value="${tutor.id}" selected>${tutor.nombre}</option>`;
                    tutorSelect.disabled = false;
                    console.log('‚úÖ Tutor cargado correctamente');
                } else {
                    tutorSelect.innerHTML = '<option value="">Este alumno no tiene tutor asignado</option>';
                    console.log('‚ö†Ô∏è Sin tutor asignado');
                }
            } catch (error) {
                console.error('‚ùå Error al cargar tutor:', error);
                tutorSelect.innerHTML = '<option value="">Error al cargar tutor</option>';
            }
        });
        
        // Inicializar el filtro si hay un criterio preseleccionado (modo edici√≥n)
        window.addEventListener('DOMContentLoaded', function() {
            const criterioSelect = document.getElementById('criterio');
            const capacidadSelect = document.getElementById('capacidad');
            
            // Si hay criterio Y capacidad seleccionados (modo edici√≥n)
            if (criterioSelect.value && capacidadSelect.value) {
                console.log('üîÑ Modo edici√≥n detectado');
                // Marcar como carga inicial para no limpiar la capacidad
                criterioSelect.dataset.initialLoad = 'true';
                // Habilitar capacidad y filtrar opciones
                capacidadSelect.disabled = false;
                criterioSelect.dispatchEvent(new Event('change'));
            } else if (criterioSelect.value) {
                // Solo hay criterio seleccionado
                criterioSelect.dispatchEvent(new Event('change'));
            }
            
            // Si hay alumno preseleccionado (modo edici√≥n), cargar su tutor
            const alumnoSelect = document.getElementById('alumno');
            if (alumnoSelect && alumnoSelect.value) {
                console.log('üîÑ Alumno preseleccionado');
                alumnoSelect.dispatchEvent(new Event('change'));
            }
        });
    </script>
</th:block>