<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<div th:fragment="content">
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-people-fill me-2"></i> Gestión de Alumnos</h2>

            <!-- Solo ADMIN puede crear alumnos -->
			<div th:if="${#lists.contains(#authentication.authorities.![authority], 'ADMIN')}">
			    <a th:href="@{/admin/alumno/nuevo}" class="btn btn-primary">
			        <i class="bi bi-plus-circle"></i> Nuevo Alumno
			    </a>
			</div>

        </div>

        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> <span th:text="${success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
				<!--	<p th:text="${#authorization.expression('hasAuthority(''TUTOR_CURSO'')')}"></p>
					<p th:text="${#authorization.expression('hasAuthority(''ADMIN'')')}"></p> -->
                    <table class="table table-hover table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>DNI</th>
                                <th>Nombre</th>
                                <th>Apellidos</th>
                                <th>Email</th>
                                <th>Curso</th>
                                <th>Empresa</th>
                                <th>Estado</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${alumnos == null || alumnos.isEmpty()}">
                                <td colspan="8" class="text-center text-muted">
                                    <i class="bi bi-inbox"></i> No hay alumnos registrados
                                </td>
                            </tr>

                            <tr th:each="alumno : ${alumnos}">
                                <td th:text="${alumno.dni}"></td>
                                <td th:text="${alumno.nombre}"></td>
                                <td th:text="${alumno.apellidos}"></td>
                                <td th:text="${alumno.email}"></td>
                                <td>
                                    <span th:if="${alumno.curso != null}" th:text="${alumno.curso.nombre}"></span>
                                    <span th:if="${alumno.curso == null}" class="text-muted">-</span>
                                </td>
                                <td>
                                    <span th:if="${alumno.empresa != null}" th:text="${alumno.empresa.nombre}"></span>
                                    <span th:if="${alumno.empresa == null}" class="text-muted">-</span>
                                </td>
                                <td>
                                    <span th:if="${alumno.activo}" class="badge bg-success">Activo</span>
                                    <span th:unless="${alumno.activo}" class="badge bg-secondary">Inactivo</span>
                                </td>
                                <td class="text-center">
									<div class="btn-group" role="group">

									    <!-- ADMIN -->
									    <div th:if="${#lists.contains(#authentication.authorities.![authority], 'ADMIN')}">
									        <a th:if="${!alumno.tieneUsuario}"
									           th:href="@{/admin/alumno/crear-usuario/{id}(id=${alumno.id})}"
									           class="btn btn-sm btn-info"
									           title="Crear Usuario"
									           onclick="return confirm('¿Crear usuario de acceso para este alumno?')">
									            <i class="bi bi-person-plus"></i>
									        </a>
									        <a th:href="@{/admin/alumno/editar/{id}(id=${alumno.id})}"
									           class="btn btn-sm btn-warning"
									           title="Editar">
									            <i class="bi bi-pencil"></i>
									        </a>
									        
									        <!-- Botón Activar/Desactivar -->
                                        <form th:if="${#lists.contains(#authentication.authorities.![authority], 'ADMIN')}"
                                        		th:action="@{/admin/alumno/cambiar-estado/{id}(id=${alumno.id})}" 
                                              method="post" 
                                              style="display: inline;">
                                            <button type="submit" 
                                                    class="btn btn-sm"
                                                    th:classappend="${alumno.activo} ? 'btn-success' : 'btn-secondary'"
                                                    th:title="${alumno.activo} ? 'Desactivar' : 'Activar'">
                                                <i th:class="${alumno.activo} ? 'bi bi-toggle-off' : 'bi bi-toggle-on'"></i>
                                            </button>
                                        </form>
									        
									        <a th:href="@{/admin/alumno/eliminar/{id}(id=${alumno.id})}"
									           class="btn btn-sm btn-danger"
									           title="Eliminar"
									           onclick="return confirm('¿Está seguro de eliminar este alumno?')">
									            <i class="bi bi-trash"></i>
									        </a>
									    </div>

									    <!-- TUTOR_PRACTICAS -->
									    <div th:if="${#lists.contains(#authentication.authorities.![authority], 'TUTOR_PRACTICAS')}">
									        <a th:href="@{/tutorpracticas/alumno/editar/{id}(id=${alumno.id})}"
									           class="btn btn-sm btn-warning"
									           title="Editar perfil del alumno">
									            <i class="bi bi-pencil-square"></i>
									        </a>
									    </div>

									    <!-- TUTOR_CURSO -->
									    <div th:if="${#lists.contains(#authentication.authorities.![authority], 'TUTOR_CURSO')}">
									        <a th:href="@{/tutorcurso/alumno/editar/{id}(id=${alumno.id})}"
									           class="btn btn-sm btn-warning"
									           title="Editar alumno asignado">
									            <i class="bi bi-pencil"></i>
									        </a>
									    </div>

									</div>

                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Estadísticas -->
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5>Total Alumnos</h5>
                        <h2 th:text="${#lists.size(alumnos)}"></h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5>Alumnos Activos</h5>
                        <h2 th:text="${#lists.size(alumnos.?[activo == true])}"></h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-secondary text-white">
                    <div class="card-body">
                        <h5>Alumnos Inactivos</h5>
                        <h2 th:text="${#lists.size(alumnos.?[activo == false])}"></h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block th:fragment="scripts">
    <script>
     console.log('Script cargado');
    </script>
</th:block>
</html>
