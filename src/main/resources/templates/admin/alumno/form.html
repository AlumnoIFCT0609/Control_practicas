<html xmlns:th="http://www.thymeleaf.org">

<div th:fragment="content">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">
                            <i class="bi bi-person-plus"></i>
                            <span th:text="${alumno.id == null ? 'Nuevo Alumno' :
                                (#lists.contains(#authentication.authorities.![authority], 'ALUMNO') ? 'Mi Perfil' : 'Editar Alumno')}">
                                Nuevo Alumno
                            </span>
                        </h3>
                    </div>

                    <div class="card-body">

                        <form th:object="${alumno}"
                              method="post"
                              th:action="
                                ${#lists.contains(#authentication.authorities.![authority], 'ALUMNO') ? '/alumno/perfil' :
                                  (#lists.contains(#authentication.authorities.![authority], 'TUTOR_PRACTICAS') ? '/tutorpracticas/alumno/guardar' :
                                  (#lists.contains(#authentication.authorities.![authority], 'TUTOR_CURSO') ? '/tutorcurso/alumno/guardar' :
                                  '/admin/alumno/guardar'))}">

                            <input type="hidden" th:field="*{id}" />

                            <!-- DATOS PERSONALES -->
                            <h5 class="border-bottom pb-2 mb-3">Datos Personales</h5>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="dni" class="form-label">DNI <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="dni"
                                           th:field="*{dni}"
                                           placeholder="DNI"
                                           required
                                           th:disabled="${#lists.contains(#authentication.authorities.![authority], 'ALUMNO')}" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email"
                                           th:field="*{email}"
                                           placeholder="alumno@ejemplo.com"
                                           required
                                           th:disabled="${#lists.contains(#authentication.authorities.![authority], 'ALUMNO')}" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="nombre" class="form-label">Nombre <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="nombre"
                                           th:field="*{nombre}"
                                           required
                                           th:disabled="${#lists.contains(#authentication.authorities.![authority], 'ALUMNO')}" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="apellidos" class="form-label">Apellidos <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="apellidos"
                                           th:field="*{apellidos}"
                                           required
                                           th:disabled="${#lists.contains(#authentication.authorities.![authority], 'ALUMNO')}" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                                    <input type="date" class="form-control" id="fechaNacimiento"
										   name="fechaNacimiento"
                                           th:value="${alumno.fechaNacimiento != null ? alumno.fechaNacimiento.toString() : ''}"
                                           th:disabled="${#lists.contains(#authentication.authorities.![authority], 'ALUMNO')}" />
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="telefono" class="form-label">Teléfono</label>
                                    <input type="tel" class="form-control" id="telefono"
                                           th:field="*{telefono}"
                                           placeholder="Teléfono" />
                                </div>
                            </div>

                            <!-- DATOS ACADÉMICOS Y PRÁCTICAS -->
                            <h5 class="border-bottom pb-2 mb-3 mt-4">Datos Académicos y Prácticas</h5>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="curso" class="form-label">Curso <span class="text-danger">*</span></label>
                                    <select class="form-select" id="curso" th:field="*{cursoId}" required
                                            th:disabled="${#lists.contains(#authentication.authorities.![authority], 'TUTOR_PRACTICAS')
                                                          or #lists.contains(#authentication.authorities.![authority], 'ALUMNO')
														  or #lists.contains(#authentication.authorities.![authority], 'TUTOR_CURSO')}">
                                        
									<option value="" th:if="${#lists.contains(#authentication.authorities.![authority], 'ADMIN')}">
											      Seleccione un curso
									 </option>
                                        <option th:each="curso : ${cursos}"
                                                th:value="${curso.id}"
                                                th:text="${curso.nombre}"
                                                th:selected="${alumno.curso != null and alumno.curso.id == curso.id}">
                                        </option>
                                    </select>
                                </div>

                                    <!--  
                                    <select class="form-select" id="empresa" th:field="*{empresaId}"
                                            th:disabled="${#lists.contains(#authentication.authorities.![authority], 'TUTOR_PRACTICAS')
                                                          or #lists.contains(#authentication.authorities.![authority], 'ALUMNO')
														  or #lists.contains(#authentication.authorities.![authority], 'TUTOR_CURSO')}">
                                       
										<option value="" th:if="${#lists.contains(#authentication.authorities.![authority], 'ADMIN')}">
										    Seleccione una empresa
										</option>
                                        <option th:each="empresa : ${empresas}"
                                                th:value="${empresa.id}"
                                                th:text="${empresa.nombre}"
                                                th:selected="${alumno.empresa != null and alumno.empresa.id == empresa.id}">
                                        </option>
                                    </select> -->
                                
                                <div class="col-md-6 mb-3">
                                    <label for="empresa" class="form-label">Empresa</label>     
                                <select class="form-select"
                                            id="empresaId"
                                            th:field="*{empresaId}"
                                            required
                                            onchange="cargarTutoresPorEmpresa()"
                                            th:disabled="${#lists.contains(#authentication.authorities.![authority], 'ALUMNO')
                                            			or #lists.contains(#authentication.authorities.![authority], 'TUTOR_PRACTICAS')
                                            			or #lists.contains(#authentication.authorities.![authority], 'TUTOR_CURSO')}">
                                        <option value="">Seleccione una Empresa</option>
                                        <option th:each="empresa : ${empresas}"
                                                th:value="${empresa.id}"
                                                th:text="${empresa.nombre}">
                                        </option>
                                    </select>
                                </div>
                                
                                
                                
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="tutorPracticas" class="form-label">Tutor de Prácticas</label>
                                    <select class="form-select" id="tutorPracticas" th:field="*{tutorPracticasId}"
									th:disabled="${#lists.contains(#authentication.authorities.![authority], 'TUTOR_PRACTICAS')
									           	or #lists.contains(#authentication.authorities.![authority], 'ALUMNO')
												or #lists.contains(#authentication.authorities.![authority], 'TUTOR_CURSO')}">
										<option value="" th:if="${#lists.contains(#authentication.authorities.![authority], 'ADMIN')}">
										    Seleccione un tutor
										</option>                   
										<option th:each="tutor : ${tutorPracticas}"
                                                th:value="${tutor.id}"
                                                th:text="${tutor.nombre + ' ' + tutor.apellidos}"
                                                th:selected="${alumno.tutorPracticas != null and alumno.tutorPracticas.id == tutor.id}">
                                        </option>
                                    </select>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="duracionPracticas" class="form-label">Duración Prácticas (horas)</label>
                                    <input type="number" class="form-control" id="duracionPracticas"
                                           th:field="*{duracionPracticas}"
                                           placeholder="Horas" />
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="horario" class="form-label">Horario <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="horario"
                                       th:field="*{horario}"
                                       placeholder="Horario" required />
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fechaInicio" class="form-label">Fecha Inicio <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="fechaInicio" name="fechaInicio"
                                           th:value="${alumno.fechaInicio != null ? alumno.fechaInicio.toString() : ''}" required />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="fechaFin" class="form-label">Fecha Fin <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="fechaFin"  name="fechaFin"
                                           th:value="${alumno.fechaFin != null ? alumno.fechaFin.toString() : ''}" required />
                                </div>
                            </div>

                            <!-- ESTADO (solo no alumnos) -->
                            <div class="mb-3"
                                 th:if="${!#lists.contains(#authentication.authorities.![authority], 'ALUMNO')}">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="activo" th:field="*{activo}">
                                    <label class="form-check-label" for="activo">Activo</label>
                                </div>
                            </div>

                            <!-- BOTONES -->
                            <div class="d-flex justify-content-between mt-4">
                                <a th:href="${
                                    #lists.contains(#authentication.authorities.![authority], 'ALUMNO') ? '/alumno/dashboard' :
                                    (#lists.contains(#authentication.authorities.![authority], 'TUTOR_PRACTICAS') ? '/tutorpracticas/alumno' :
                                    (#lists.contains(#authentication.authorities.![authority], 'TUTOR_CURSO') ? '/tutorcurso/alumno' :
                                    '/admin/alumno/listar'))}"
                                   class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Cancelar
                                </a>

                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Guardar
                                </button>
                            </div>

                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<th:block th:fragment="scripts">
    <script>
    function cargarTutoresPorEmpresa() {
        const empresaId = document.getElementById('empresaId').value;
        const tutorSelect = document.getElementById('tutorPracticas');
        
        console.log('Función llamada. Empresa ID:', idempresa);
        
        tutorSelect.innerHTML = '<option value="">Cargando...</option>';
        
        if (!empresaId) {
        	 tutorSelect.innerHTML = '<option value="">Primero seleccione una empresa</option>';
            return;
        }
        
        const url = `/admin/alumno/tutores-por-empresa/${empresaId}`;
        console.log('Haciendo fetch a:', url);
        
        fetch(url)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(alumnos => {
                console.log('Tutores de practicas recibidos:', tutoresPracticas);
                
                alumnoSelect.innerHTML = '<option value="">Seleccione un Tutor de Practicas</option>';
                
                alumnos.forEach(alumno => {
                    const option = document.createElement('option');
                    option.value = tutorPracticas.id;
                    option.textContent = tutorPracticas.nombre;
                    TutorSelect.appendChild(option);
                });
                
                if (alumnos.length === 0) {
                    alumnoSelect.innerHTML = '<option value="">No hay Tutores de practicas para esta empresa</option>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alumnoSelect.innerHTML = '<option value="">Error al cargar Tutores de practicas</option>';
            });
    }
    
    console.log('Script cargado');
    </script>
</th:block>


</html>

